!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("vega-util"),require("vega-expression")):"function"==typeof define&&define.amd?define(["exports","vega-util","vega-expression"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self).vega={},e.vega,e.vega)}(this,(function(e,t,n){"use strict";const r="intersect",i="union";var u="index:unit";function o(e,n){for(var r,i,u=n.fields,o=n.values,a=u.length,f=0;f<a;++f)if((i=u[f]).getter=t.field.getter||t.field(i.field),r=i.getter(e),t.isDate(r)&&(r=t.toNumber(r)),t.isDate(o[f])&&(o[f]=t.toNumber(o[f])),t.isDate(o[f][0])&&(o[f]=o[f].map(t.toNumber)),"E"===i.type){if(t.isArray(o[f])?o[f].indexOf(r)<0:r!==o[f])return!1}else if("R"===i.type){if(!t.inrange(r,o[f]))return!1}else if("R-RE"===i.type){if(!t.inrange(r,o[f],!0,!1))return!1}else if("R-E"===i.type){if(!t.inrange(r,o[f],!1,!1))return!1}else if("R-LE"===i.type&&!t.inrange(r,o[f],!1,!0))return!1;return!0}var a={E_union:function(e,t){if(!e.length)return t;for(var n=0,r=t.length;n<r;++n)e.indexOf(t[n])<0&&e.push(t[n]);return e},E_intersect:function(e,t){return e.length?e.filter((e=>t.indexOf(e)>=0)):t},R_union:function(e,n){var r=t.toNumber(n[0]),i=t.toNumber(n[1]);return r>i&&(r=n[1],i=n[0]),e.length?(e[0]>r&&(e[0]=r),e[1]<i&&(e[1]=i),e):[r,i]},R_intersect:function(e,n){var r=t.toNumber(n[0]),i=t.toNumber(n[1]);return r>i&&(r=n[1],i=n[0]),e.length?i<e[0]||e[1]<r?[]:(e[0]<r&&(e[0]=r),e[1]>i&&(e[1]=i),e):[r,i]}};e.selectionResolve=function(e,n,r){for(var u,o,f,s,l,c,d,g,v,p,h,y=this.context.data[e],b=y?y.values.value:[],m={},x={},R={},O=b.length,_=0;_<O;++_){for(s=(u=b[_]).unit,o=u.fields,f=u.values,p=0,h=o.length;p<h;++p)l=o[p],d=(c=m[l.field]||(m[l.field]={}))[s]||(c[s]=[]),R[l.field]=g=l.type.charAt(0),v=a[g+"_union"],c[s]=v(d,t.array(f[p]));r&&(d=x[s]||(x[s]=[])).push(t.array(f).reduce(((e,t,n)=>(e[o[n].field]=t,e)),{}))}return n=n||i,Object.keys(m).forEach((e=>{m[e]=Object.keys(m[e]).map((t=>m[e][t])).reduce(((t,r)=>void 0===t?r:a[R[e]+"_"+n](t,r)))})),b=Object.keys(x),r&&b.length&&(m.vlMulti=n===i?{or:b.reduce(((e,t)=>(e.push(...x[t]),e)),[])}:{and:b.map((e=>({or:x[e]})))}),m},e.selectionTest=function(e,t,n){for(var i,a,f,s,l,c=this.context.data[e],d=c?c.values.value:[],g=c?c[u]&&c[u].value:void 0,v=n===r,p=d.length,h=0;h<p;++h)if(i=d[h],g&&v){if(-1===(f=(a=a||{})[s=i.unit]||0))continue;if(l=o(t,i),a[s]=l?-1:++f,l&&1===g.size)return!0;if(!l&&f===g.get(s).count)return!1}else if(v^(l=o(t,i)))return l;return p&&v},e.selectionVisitor=function(e,i,u,o){i[0].type!==n.Literal&&t.error("First argument to selection functions must be a string literal.");const a=i[0].value,f="unit",s="@unit",l=":"+a;(i.length>=2&&t.peek(i).value)!==r||t.hasOwnProperty(o,s)||(o["@unit"]=u.getData(a).indataRef(u,f)),t.hasOwnProperty(o,l)||(o[l]=u.getData(a).tuplesRef())},Object.defineProperty(e,"__esModule",{value:!0})}));
//# sourceMappingURL=vega-selection.min.js.map
